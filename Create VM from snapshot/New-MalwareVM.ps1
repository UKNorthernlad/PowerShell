# Taken from https://learn.microsoft.com/en-us/azure/virtual-machines/attach-os-disk?tabs=powershell

###########################################################################################
# Create a new disk from an existing snapshop then attach the disk to a new virtual machine
###########################################################################################

$Location = "Sweden Central"
$VMName = "analysis01"

# used to add suffix to the resource group name when multiple environment are required
$ResourceGroupInstance = "-1" 

#Login-AzAccount -Tenant XXXXXXXXX
#Get-AzSubscription -SubscriptionId XXXXXXXXXX | Select-AzSubscription

# Create resource group for new VM
$newResourceGroup = New-AzResourceGroup -Name "$($VMName)RG$ResourceGroupInstance" -Location $Location

# Create the new disk from an existing snapshot
$snapshotResourceGroupName = 'Backups'
$snapshotName = "basicMalwareBuild02"
$snapshot = Get-AzSnapshot -ResourceGroupName $snapshotResourceGroupName -SnapshotName $snapshotName 
$diskConfig = New-AzDiskConfig -SkuName "Standard_LRS" -Location $Location -CreateOption Copy -SourceResourceId $snapshot.Id -DiskSizeGB 128
$osDisk = New-AzDisk -Disk $diskConfig -ResourceGroupName $newResourceGroup.ResourceGroupName -DiskName "$($VMName)-disk"

# Create new subnet and add it to a new virtual network
$subnetName = 'mySubNet'
$singleSubnet = New-AzVirtualNetworkSubnetConfig -Name $subnetName -AddressPrefix 10.0.0.0/24
$vnetName = "myVnetName"
$vnet = New-AzVirtualNetwork -Name $vnetName -ResourceGroupName $newResourceGroup.ResourceGroupName -Location $Location -AddressPrefix 10.0.0.0/16 -Subnet $singleSubnet

# Add network security group and allow RDP access
$nsgName = "myNsg"
$rdpRule = New-AzNetworkSecurityRuleConfig -Name myRdpRule -Description "Allow RDP" -Access Allow -Protocol Tcp -Direction Inbound -Priority 110 -SourceAddressPrefix Internet -SourcePortRange * -DestinationAddressPrefix * -DestinationPortRange 3389
$nsg = New-AzNetworkSecurityGroup -ResourceGroupName $newResourceGroup.ResourceGroupName -Location $Location -Name $nsgName -SecurityRules $rdpRule

# Create the public IP
$ipName = "$VMName"+"-ip"
$pip = New-AzPublicIpAddress -Name $ipName -ResourceGroupName $newResourceGroup.ResourceGroupName -Location $Location -AllocationMethod Static
   
# Create the network card
$nicName = "$VMName"+"-nic"
$nic = New-AzNetworkInterface -Name $nicName -ResourceGroupName $newResourceGroup.ResourceGroupName -Location $Location -SubnetId $vnet.Subnets[0].Id -PublicIpAddressId $pip.Id -NetworkSecurityGroupId $nsg.Id 

# Set name of VM resource and size required.
$vmConfig = New-AzVMConfig -VMName $VMName -VMSize "Standard_D4s_v3"

# The $vm object contains the final settings for the VM we want
$vm = Add-AzVMNetworkInterface -VM $vmConfig -Id $nic.Id

# Here is where we reference the existing disk we want
$vm = Set-AzVMOSDisk -VM $vm -ManagedDiskId $osDisk.Id -StorageAccountType Standard_LRS -DiskSizeInGB 128 -CreateOption Attach -Windows

# Create the VM
New-AzVM -ResourceGroupName $newResourceGroup.ResourceGroupName -Location $location -VM $vm

# Test
$vmList = Get-AzVM -ResourceGroupName $newResourceGroup.ResourceGroupName
$vmList.Name